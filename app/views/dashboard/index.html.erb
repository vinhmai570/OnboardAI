<div class="min-h-screen bg-gray-50">
  <nav class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex">
          <div class="flex-shrink-0 flex items-center">
            <h1 class="text-2xl font-bold text-gray-900">OnboardAI</h1>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <!-- Main Navigation -->
          <div class="hidden md:flex items-center space-x-4">
            <%= link_to "Dashboard", dashboard_path, class: "text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium" %>
            <%= link_to "Courses", courses_path, class: "text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium" %>
            <%= link_to "My Progress", progress_index_path, class: "text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium" %>

            <% if admin? %>
              <div class="relative">
                <button class="text-indigo-600 hover:text-indigo-900 px-3 py-2 rounded-md text-sm font-medium" onclick="toggleDropdown()">
                  Admin â–¼
                </button>
                <div id="admin-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
                  <%= link_to "Admin Dashboard", admin_dashboard_path, class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
                  <%= link_to "Course Generator", admin_course_generator_index_path, class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
                  <%= link_to "Quiz Management", admin_quizzes_path, class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
                  <%= link_to "Learning Analytics", dashboard_progress_index_path, class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
                  <%= link_to "Document Management", admin_documents_path, class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
                </div>
              </div>
            <% end %>
          </div>

          <!-- User Menu -->
          <div class="flex items-center space-x-2">
            <span class="text-gray-700 text-sm">Welcome, <%= current_user.name || current_user.email %></span>
            <%= link_to "Logout", logout_path, method: :delete, class: "text-red-600 hover:text-red-900 text-sm" %>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0">
      <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-900">Your Learning Dashboard</h2>
        <p class="mt-2 text-gray-600">Track your progress and continue your onboarding journey.</p>
      </div>

      <!-- Progress Metrics Overview -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white p-4 rounded-lg shadow-sm border">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600">Assigned Courses</p>
              <p class="text-2xl font-bold text-blue-600"><%= @progress_metrics[:total_courses_assigned] %></p>
            </div>
            <div class="h-8 w-8 bg-blue-100 rounded-lg flex items-center justify-center">
              <svg class="h-4 w-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-sm border">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600">Completed</p>
              <p class="text-2xl font-bold text-green-600"><%= @progress_metrics[:courses_completed] %></p>
            </div>
            <div class="h-8 w-8 bg-green-100 rounded-lg flex items-center justify-center">
              <svg class="h-4 w-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-sm border">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600">Avg Progress</p>
              <p class="text-2xl font-bold text-purple-600"><%= @progress_metrics[:average_completion] %>%</p>
            </div>
            <div class="h-8 w-8 bg-purple-100 rounded-lg flex items-center justify-center">
              <svg class="h-4 w-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-sm border">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600">Quiz Average</p>
              <p class="text-2xl font-bold text-orange-600"><%= @progress_metrics[:average_quiz_score] %>%</p>
            </div>
            <div class="h-8 w-8 bg-orange-100 rounded-lg flex items-center justify-center">
              <svg class="h-4 w-4 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Assigned Courses -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
          <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-medium text-gray-900">Assigned Courses</h3>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                <%= @assigned_courses.count %> assigned
              </span>
            </div>
            <% if @assigned_courses.any? %>
              <div class="space-y-4">
                <% @assigned_courses.each do |assignment| %>
                  <% course = assignment.course %>
                  <% progress_data = current_user.progress_for_course(course) %>
                  <% completion_percentage = progress_data[:completion_percentage] %>
                  <% completed_items = progress_data[:completed_steps] %>
                  <% total_items = progress_data[:total_steps] %>
                  <% progress_type = "steps" %>
                  <div class="border border-gray-200 rounded-lg p-4 <%= completion_percentage >= 100 ? 'bg-green-50 border-green-200' : '' %>">
                    <div class="flex justify-between items-start mb-2">
                      <div class="flex-1">
                        <div class="flex items-center">
                          <h4 class="text-lg font-medium text-gray-900"><%= course.title %></h4>
                          <% if completion_percentage >= 100 %>
                            <svg class="w-5 h-5 text-green-500 ml-2" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                            </svg>
                          <% end %>
                        </div>
                        <div class="mt-1 space-y-1">
                          <div class="flex items-center text-sm text-gray-600">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Progress: <%= completion_percentage %>% (<%= completed_items %>/<%= total_items %> <%= progress_type %>)
                          </div>
                          <div class="flex items-center text-sm text-gray-600">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                              <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6z"/>
                            </svg>
                            Assigned: <%= time_ago_in_words(assignment.assigned_at) %> ago
                          </div>
                          <% if progress_data[:in_progress_steps] > 0 %>
                            <div class="flex items-center text-sm text-yellow-600">
                              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z"/>
                              </svg>
                              <%= progress_data[:in_progress_steps] %> step(s) in progress
                            </div>
                          <% end %>
                        </div>
                      </div>
                      <%= link_to "Continue", course_path(course), class: "inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
                    </div>
                    <div class="mt-3">
                      <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: <%= completion_percentage %>%"></div>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="text-center py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No assigned courses</h3>
                <p class="mt-1 text-sm text-gray-500">Your admin will assign courses to you for training.</p>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Self-Enrolled Courses -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
          <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-medium text-gray-900">Your Learning Journey</h3>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                <%= @enrolled_courses.count %> enrolled
              </span>
            </div>
            <% enrolled_not_assigned = @enrolled_courses.where.not(id: @assigned_courses.pluck(:course_id)) %>
            <% if enrolled_not_assigned.any? %>
              <div class="space-y-4">
                <% enrolled_not_assigned.each do |course| %>
                  <% progress_data = current_user.progress_for_course(course) %>
                  <% completion_percentage = progress_data[:completion_percentage] %>
                  <% completed_items = progress_data[:completed_steps] %>
                  <% total_items = progress_data[:total_steps] %>
                  <% progress_type = "steps" %>
                  <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <h4 class="text-lg font-medium text-gray-900"><%= course.title %></h4>
                        <div class="mt-1 space-y-1">
                          <div class="flex items-center text-sm text-gray-600">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Progress: <%= completion_percentage %>% (<%= completed_items %>/<%= total_items %> <%= progress_type %>)
                          </div>
                          <% if course.structured? %>
                            <% in_progress_modules = module_progress[:module_progress].count { |mp| mp[:completion_percentage] > 0 && mp[:completion_percentage] < 100 } %>
                            <% if in_progress_modules > 0 %>
                              <div class="flex items-center text-sm text-yellow-600">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z"/>
                                </svg>
                                <%= in_progress_modules %> module(s) in progress
                              </div>
                            <% end %>
                          <% else %>
                            <% progress_data = current_user.progress_for_course(course) %>
                            <% if progress_data[:in_progress_steps] > 0 %>
                              <div class="flex items-center text-sm text-yellow-600">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z"/>
                                </svg>
                                <%= progress_data[:in_progress_steps] %> step(s) in progress
                              </div>
                            <% end %>
                          <% end %>
                        </div>
                      </div>
                      <%= link_to "Continue", course_path(course), class: "inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
                    </div>
                    <div class="mt-2">
                      <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-indigo-600 h-2 rounded-full" style="width: <%= completion_percentage %>%"></div>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="text-center py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Explore available courses</h3>
                <p class="mt-1 text-sm text-gray-500">Discover new learning opportunities below.</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Available Courses -->
      <div class="mt-8">
        <div class="bg-white overflow-hidden shadow rounded-lg">
          <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Available Courses</h3>
            <% if @available_courses.any? %>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <% @available_courses.each do |course| %>
                  <div class="border border-gray-200 rounded-lg p-4 hover:border-indigo-300 transition-colors">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <h4 class="text-lg font-medium text-gray-900"><%= course.title %></h4>
                        <div class="mt-2 space-y-1">
                          <div class="flex items-center text-sm text-gray-600">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <%= course.course_modules.sum { |m| m.course_steps.count } %> steps
                          </div>
                          <% if course.course_modules.any? %>
                            <div class="flex items-center text-sm text-gray-600">
                              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                              </svg>
                              <%= course.course_modules.count %> modules
                            </div>
                          <% end %>
                        </div>
                        <div class="mt-4">
                          <%= link_to "Start Learning", course_path(course), method: :post, class: "inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="text-center py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">All caught up!</h3>
                <p class="mt-1 text-sm text-gray-500">No new courses available at the moment.</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
function toggleDropdown() {
  const dropdown = document.getElementById('admin-dropdown');
  dropdown.classList.toggle('hidden');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const dropdown = document.getElementById('admin-dropdown');
  const button = event.target.closest('button');

  if (dropdown && !dropdown.contains(event.target) && !button) {
    dropdown.classList.add('hidden');
  }
});
</script>
